---
import Base from "../../layouts/Base.astro";
import { fetchLegalDocBySlug } from "../../lib/api";
import { renderMarkdown } from "../../lib/markdown";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/");
}

let doc;
try {
  doc = await fetchLegalDocBySlug(slug);
} catch (e) {
  console.warn("[CMS] Failed to fetch legal document:", e instanceof Error ? e.message : e);
  return new Response(null, { status: 404, statusText: "Not Found" });
}

const loc = doc.localizations[0];
const title = loc?.title ?? slug.replace(/-/g, " ");
const intro = renderMarkdown(loc?.intro);
---

<Base title={title}>
  <article class="legal-page">
    <h1>{title}</h1>
    {intro.length > 0 && <div class="legal-page__intro" set:html={intro} />}
    <p class="legal-page__meta">
      Last updated: {new Date(doc.updated_at).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      })}
    </p>
  </article>
</Base>
